name: Build Python to EXE

on:
  push:
    branches:
      - app
    paths:
      - '**/*.py' # Hanya aktif jika file .py diubah
  workflow_dispatch: # Tetap mendukung pemicu manual
    inputs:
      branchRef:
        description: 'Branch to deploy'
        required: true
        default: 'app'

jobs:
  build:
    runs-on: windows-latest

    steps:
    # Langkah 1: Checkout kode
    - name: Checkout code
      uses: actions/checkout@v3

    # Langkah 2: Setup Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.10

    # Langkah 3: Temukan file .py yang diubah
    - name: Find modified Python files
      id: find_files
      run: |
        echo "Checking for modified Python files..."
        CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.py$' || echo "")
        if [ -z "$CHANGED_FILES" ]; then
          echo "No Python files changed. Exiting..."
          exit 0
        fi
        echo "Modified Python files:"
        echo "$CHANGED_FILES"
        echo "::set-output name=files::$CHANGED_FILES"

    # Langkah 4: Build EXE untuk setiap file .py yang diubah
    - name: Build EXE with PyInstaller
      run: |
        IFS=$'\n'
        for file in ${{ steps.find_files.outputs.files }}; do
          echo "Building EXE for $file..."
          pyinstaller --onefile --distpath dist --workpath build --specpath spec "$file"
        done
      shell: bash

    # Langkah 5: Upload EXE as artifact
    - name: Upload EXE as artifact
      uses: actions/upload-artifact@v3
      with:
        name: exe-files
        path: dist/*.exe
