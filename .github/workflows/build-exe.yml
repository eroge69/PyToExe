name: Build Python to EXE

on:
  push:
    branches:
      - app
  workflow_dispatch:
    inputs:
      branchRef:
        description: 'Branch to deploy'
        required: true
        default: 'app'

jobs:
  build:
    runs-on: windows-latest

    steps:
    # Langkah 1: Checkout kode
    - name: Checkout code
      uses: actions/checkout@v3

    # Langkah 2: Setup Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.10

    # Langkah 3: Temukan file .py yang diubah atau dihapus
    - name: Find modified or deleted Python files
      id: find_files
      run: |
        Write-Host "Checking for modified or deleted Python files..."
        $CHANGED_FILES = git diff --name-status ${{ github.event.before }} ${{ github.sha }} | Select-String -Pattern '\.py$' -SimpleMatch
        $MODIFIED_FILES = $CHANGED_FILES | Where-Object { $_.Line.StartsWith('M') } | ForEach-Object { $_.Line.Split("`t")[1] }
        $DELETED_FILES = $CHANGED_FILES | Where-Object { $_.Line.StartsWith('D') } | ForEach-Object { $_.Line.Split("`t")[1] }
        
        if (-not $MODIFIED_FILES -and -not $DELETED_FILES) {
          Write-Host "No Python files modified or deleted. Exiting..."
          exit 0
        }
        
        Write-Host "Modified Python files: $MODIFIED_FILES"
        Write-Host "Deleted Python files: $DELETED_FILES"
        
        echo "::set-output name=modified::$MODIFIED_FILES"
        echo "::set-output name=deleted::$DELETED_FILES"
      shell: pwsh

    # Langkah 4: Build EXE untuk file .py yang diubah
    - name: Build EXE for modified Python files
      if: ${{ steps.find_files.outputs.modified != '' }}
      run: |
        $modifiedFiles = "${{ steps.find_files.outputs.modified }}"
        foreach ($file in $modifiedFiles.Split(","))
        {
          Write-Host "Building EXE for $file..."
          pyinstaller --onefile --distpath dist --workpath build --specpath spec $file
        }
      shell: pwsh

    # Langkah 5: Log penghapusan file
    - name: Log deleted files
      if: ${{ steps.find_files.outputs.deleted != '' }}
      run: |
        Write-Host "The following Python files were deleted:"
        Write-Host "${{ steps.find_files.outputs.deleted }}"
      shell: pwsh
